name: Auto Test Generation

on:
  pull_request:
    paths:
      - 'src/**/*.jsx'
      - 'src/**/*.tsx'

jobs:
  generate-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout React project
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install npm dependencies
        run: npm install --legacy-peer-deps

      - name: Get changed files
        id: changed-files
        run: |
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Generate tests with Agentic System
        if: steps.changed-files.outputs.files != ''
        uses: prakalps/UnitTestGenerationSystem/.github/actions/generate-tests@main
        with:
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          files: ${{ steps.changed-files.outputs.files }}
          max_retries: 3
          min_coverage: 70
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Run generated tests
        run: npm test -- --coverage

      - name: Commit generated tests
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
          git push

      - name: Comment PR with results
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('src/logs/pr_test_generation.json', 'utf8'));

            const comment = `## ðŸ¤– Agentic Test Generation Results

            **Files Processed:** ${results.filesProcessed}
            **Tests Generated:** ${results.testsGenerated}
            **Tests Passed:** ${results.testsPassed} âœ…

            ### ðŸ’° Cost Report
            - **Total Cost:** $${results.cost_report.total_cost.toFixed(4)}
            - **Total Tokens:** ${results.cost_report.total_tokens}

            ### ðŸ“Š Coverage
            - **Statements:** ${results.coverage?.statements || 'N/A'}%
            - **Branches:** ${results.coverage?.branches || 'N/A'}%
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
